zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: a571c0d144b14fd4a87a9d9b2aa9fcd6
      name: Templates/Applications
  templates:
    - uuid: 78f0dd6c5e55404b909a3c30c91ed138
      template: 'KeepIT Office365 Backup Monitoring'
      name: 'KeepIT Office365 Backup Monitoring'
      description: |
        Template KeepIT Office365 Backup Monitoring
        
        Get KeepIT Office365 backup health by HTTP agent.
         
        Don't forget to change macros {$KEEPIT.BASE_URL}, {$KEEPIT.PASSWORD}, {$KEEPIT.USERNAME} and  {$KEEPIT.USER_ID}
        
        To Get KEEPIT.USER_ID run: https://us-dc.keepit.com/users using basic authentication, with your username and password with Postman for example or using curl
        
        curl -k "https://us-dc.keepit.com/users" -H "Authorization: Basic $(echo -n 'MYUSER:MYPASSWORD' | base64)"
        
        You can contribute this template in: 
        https://github.com/codeinfranow/zabbix-templates
        
        It's highly recommended use a custom role with monitoring rights only.
        
        Generated by Alessandro Santos - CodeInfraNow
      groups:
        - name: Templates/Applications
      items:
        - uuid: a25897c409e144929352b63c16200eb0
          name: 'KeepIT Devices XML'
          type: HTTP_AGENT
          key: keepit.devices.xml
          delay: 10m
          history: '0'
          value_type: TEXT
          trends: '0'
          authtype: BASIC
          username: '{$KEEPIT.USERNAME}'
          password: '{$KEEPIT.PASSWORD}'
          description: 'Fetch XML list of devices from KeepIT API'
          url: '{$KEEPIT.BASE_URL}/users/{$KEEPIT.USER_ID}/devices'
      discovery_rules:
        - uuid: 6601d574512c44ba8b3acdc149047162
          name: 'KeepIT Devices Discovery'
          type: DEPENDENT
          key: keepit.devices.discovery
          delay: '0'
          description: 'Discover KeepIT devices from XML'
          item_prototypes:
            - uuid: ffe43fe389894148ac9a464465de417e
              name: 'Health of {#NAME}'
              type: HTTP_AGENT
              key: 'keepit.device.health[{#GUID}]'
              delay: 10m
              value_type: CHAR
              trends: '0'
              authtype: BASIC
              username: '{$KEEPIT.USERNAME}'
              password: '{$KEEPIT.PASSWORD}'
              description: 'Fetch health status of device {#NAME}'
              preprocessing:
                - type: XMLPATH
                  parameters:
                    - /devhealth/health/text()
              url: '{$KEEPIT.BASE_URL}/users/{$KEEPIT.USER_ID}/devices/{#GUID}/health'
              trigger_prototypes:
                - uuid: 824d1bfefa134f82b5bdc5151e423002
                  expression: 'last(/KeepIT Office365 Backup Monitoring/keepit.device.health[{#GUID}])="critical"'
                  recovery_mode: RECOVERY_EXPRESSION
                  recovery_expression: 'last(/KeepIT Office365 Backup Monitoring/keepit.device.health[{#GUID}])="healthy"'
                  name: 'Critical status on {#NAME}'
                  priority: DISASTER
                  description: 'Device {#NAME} is unhealthy'
                  tags:
                    - tag: availability
                      value: '{#NAME}'
                - uuid: d6bb3130b8c6434694022777f8a9274a
                  expression: 'last(/KeepIT Office365 Backup Monitoring/keepit.device.health[{#GUID}])="unhealthy"'
                  recovery_mode: RECOVERY_EXPRESSION
                  recovery_expression: 'last(/KeepIT Office365 Backup Monitoring/keepit.device.health[{#GUID}])="healthy"'
                  name: 'Unhealthy status on {#NAME}'
                  priority: HIGH
                  description: 'Device {#NAME} is unhealthy'
                  tags:
                    - tag: availability
                      value: '{#NAME}'
          master_item:
            key: keepit.devices.xml
          preprocessing:
            - type: XML_TO_JSON
              parameters:
                - ''
            - type: JSONPATH
              parameters:
                - '$.devices.*[*]'
            - type: JAVASCRIPT
              parameters:
                - |
                  var arr = JSON.parse(value);
                  var data = [];
                  for (var i = 0; i < arr.length; i++) {
                      data.push({
                          "{#GUID}": arr[i].guid,
                          "{#NAME}": arr[i].name,
                          "{#TYPE}": arr[i].type ? arr[i].type : "system"
                      });
                  }
                  return JSON.stringify({ "data": data });
                  
      tags:
        - tag: class
          value: application
        - tag: service
          value: 'Microsoft 365 Backup'
        - tag: target
          value: keepit
      macros:
        - macro: '{$KEEPIT.BASE_URL}'
          value: 'https://us-dc.keepit.com'
          description: 'Base URL for KeepIT API'
        - macro: '{$KEEPIT.PASSWORD}'
          type: SECRET_TEXT
          description: 'Password for Basic Auth'
        - macro: '{$KEEPIT.USERNAME}'
          type: SECRET_TEXT
          description: 'Username for Basic Auth'
        - macro: '{$KEEPIT.USER_ID}'
          value: your-user-id
          description: 'User ID for KeepIT API'
